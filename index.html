<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timer with Firebase</title>
    <style>
        #timer { font-size: 24px; }
        button { margin: 5px; }
        button:disabled { opacity: 0.5; }
    </style>
</head>
<body>
    <h1>Timer Example</h1>
    <div id="timer">00:00:00</div>
    <button id="startButton">Start</button>
    <button id="stopButton" disabled>Stop</button>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
        import { getDatabase, ref, set, update, get } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyByW5mvlzUYirCE6BKChE1TbPUqsHAJCoI",
            authDomain: "tracker-80c47.firebaseapp.com",
            databaseURL: "https://tracker-80c47-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "tracker-80c47",
            storageBucket: "tracker-80c47.appspot.com",
            messagingSenderId: "857150982118",
            appId: "1:857150982118:web:ad01125d55125dc54d3827",
            measurementId: "G-QWR18QPPX2"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        let timerInterval;
        let startTime;
        let elapsedTime = 0;
        let isRunning = false;
        let lastUpdateTimestamp = 0; // The last timestamp when Firebase was updated

        function updateTimerDisplay() {
            const timerDisplay = document.getElementById('timer');
            const now = Date.now();
            const timeElapsed = isRunning ? elapsedTime + (now - lastUpdateTimestamp) : elapsedTime;
            const seconds = Math.floor((timeElapsed / 1000) % 60);
            const minutes = Math.floor((timeElapsed / (1000 * 60)) % 60);
            const hours = Math.floor((timeElapsed / (1000 * 60 * 60)) % 24);
            timerDisplay.innerText = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        function startTimer() {
    if (!isRunning) {
        startTime = Date.now();
        lastUpdateTimestamp = startTime;
        timerInterval = setInterval(() => {
            updateTimerDisplay();
            updateFirebase();  // Update Firebase every second
        }, 1000);
        isRunning = true;
        document.getElementById('startButton').disabled = true;
        document.getElementById('stopButton').disabled = false;
        updateFirebase({ isRunning: true }); // Initial update to set isRunning to true in Firebase
    }
}

        function stopTimer() {
            if (isRunning) {
                clearInterval(timerInterval);
                timerInterval = null;
                elapsedTime += Date.now() - lastUpdateTimestamp;
                isRunning = false;
                updateFirebase({ isRunning: false });
                document.getElementById('startButton').disabled = false;
                document.getElementById('stopButton').disabled = true;
            }
        }

        function updateFirebase(state = {}) {
    const timerRef = ref(database, 'timer/');
    const now = Date.now();
    const currentElapsedTime = elapsedTime + (isRunning ? now - lastUpdateTimestamp : 0);

    set(timerRef, {
        elapsedTime: currentElapsedTime, // Update with the current elapsed time
        isRunning: state.isRunning !== undefined ? state.isRunning : isRunning,
        lastUpdateTimestamp: now  // Update with current time
    }).catch((error) => {
        console.error('Error updating Firebase: ', error);
    });
}

        function loadTimer() {
            const timerRef = ref(database, 'timer/');
            get(timerRef).then((snapshot) => {
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    elapsedTime = data.elapsedTime || 0;
                    isRunning = data.isRunning || false;
                    lastUpdateTimestamp = data.lastUpdateTimestamp || Date.now();

                    if (isRunning) {
                        startTime = Date.now();
                        timerInterval = setInterval(() => {
                            updateTimerDisplay();
                            updateFirebase();  // Update Firebase every second
                        }, 1000);
                        document.getElementById('startButton').disabled = true;
                        document.getElementById('stopButton').disabled = false;
                    } else {
                        updateTimerDisplay();
                        document.getElementById('startButton').disabled = false;
                        document.getElementById('stopButton').disabled = true;
                    }
                }
            }).catch((error) => {
                console.error('Error loading timer from Firebase: ', error);
            });
        }

        window.addEventListener('load', loadTimer);
        window.addEventListener('beforeunload', () => {
            if (isRunning) {
                updateFirebase(); // Ensure Firebase is updated before page unload
            }
        });

        document.getElementById('startButton').addEventListener('click', startTimer);
        document.getElementById('stopButton').addEventListener('click', stopTimer);
    </script>
</body>
</html>
