<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Machine Stop Time Tracker</title>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-analytics.js";
        import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyByW5mvlzUYirCE6BKChE1TbPUqsHAJCoI",
            authDomain: "tracker-80c47.firebaseapp.com",
            databaseURL: "https://tracker-80c47-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "tracker-80c47",
            storageBucket: "tracker-80c47.appspot.com",
            messagingSenderId: "857150982118",
            appId: "1:857150982118:web:ad01125d55125dc54d3827",
            measurementId: "G-QWR18QPPX2"
        };

        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const database = getDatabase(app);

        const machines = ['Machine1', 'Machine2'];  // Replace with your actual machines
        const reasons = ['Reason1', 'Reason2'];    // Replace with your actual reasons

        let stopTimes = {};
        let intervals = {};
        let machineIntervals = {};
        let machineRunning = {};
        let csvData = [];

        window.init = function() {
            const machineContainer = document.getElementById('machines');
            machines.forEach(machine => {
                stopTimes[machine] = {};
                intervals[machine] = {};
                stopTimes[machine].totalElapsed = 0;
                stopTimes[machine].machineStart = null;
                machineIntervals[machine] = null;
                machineRunning[machine] = false;

                const machineDiv = document.createElement('div');
                machineDiv.className = 'machine';
                machineDiv.innerHTML = `<h2>Machine ${machine}<span id="${machine}-total-time">00:00:00</span></h2>`;

                reasons.forEach(reason => {
                    stopTimes[machine][reason] = { start: null, elapsed: 0, reasonElapsed: 0, history: [] };

                    const reasonDiv = document.createElement('div');
                    reasonDiv.className = 'stop-reason';
                    reasonDiv.innerHTML = `
                        <div id="${machine}-${reason}-reason-name">${reason}</div>
                        <span id="${machine}-${reason}-reason-time">00:00:00</span>
                        <button id="${machine}-${reason}-start-btn" onclick="startStop('${machine}', '${reason}')">Start</button>
                        <button id="${machine}-${reason}-stop-btn" class="stop disabled" onclick="stopStop('${machine}', '${reason}')" disabled>Stop</button>
                        <span id="${machine}-${reason}-time">00:00:00</span>
                    `;
                    machineDiv.appendChild(reasonDiv);
                });

                machineDiv.innerHTML += `
                    <button class="reset-btn" onclick="resetMachine('${machine}')">Reset</button>
                `;

                machineContainer.appendChild(machineDiv);
            });

            loadState();
        }

        window.updateDisplay = function(machine, reason) {
            const timeDisplay = document.getElementById(`${machine}-${reason}-time`);
            const reasonTimeDisplay = document.getElementById(`${machine}-${reason}-reason-time`);

            if (!timeDisplay || !reasonTimeDisplay) return;

            let elapsed = stopTimes[machine][reason].elapsed || 0;
            let reasonElapsed = stopTimes[machine][reason].reasonElapsed || 0;

            if (stopTimes[machine][reason].start !== null) {
                const now = Date.now();
                const diff = Math.floor((now - stopTimes[machine][reason].start) / 1000);
                elapsed += diff;
                reasonElapsed += diff;
            }
            timeDisplay.textContent = formatTime(elapsed);
            reasonTimeDisplay.textContent = formatTime(reasonElapsed);
        }

        window.updateMachineDisplay = function(machine) {
            const totalTimeDisplay = document.getElementById(`${machine}-total-time`);

            if (!totalTimeDisplay) return;

            let elapsed = stopTimes[machine].totalElapsed || 0;
            if (stopTimes[machine].machineStart !== null) {
                elapsed += Math.floor((Date.now() - stopTimes[machine].machineStart) / 1000);
            }
            totalTimeDisplay.textContent = formatTime(elapsed);
        }

        function formatTime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        function formatTimestamp(timestamp) {
            const date = new Date(timestamp);
            if (isNaN(date.getTime())) return '';

            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');

            return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
        }

        function enableStopButton(machine, reason) {
            const stopBtn = document.getElementById(`${machine}-${reason}-stop-btn`);
            if (stopBtn) {
                stopBtn.classList.remove('disabled');
                stopBtn.disabled = false;
            }
        }

        function disableMachineControls(machine, activeReason) {
            reasons.forEach(reason => {
                if (reason !== activeReason) {
                    const startBtn = document.getElementById(`${machine}-${reason}-start-btn`);
                    const stopBtn = document.getElementById(`${machine}-${reason}-stop-btn`);
                    if (startBtn) {
                        startBtn.classList.add('disabled');
                        startBtn.disabled = true;
                    }
                    if (stopBtn) {
                        stopBtn.classList.add('disabled');
                        stopBtn.disabled = true;
                    }
                }
            });
        }

        function sendWhatsAppStartMessage(machineName, stopReason, startTime) {
            const message = `${machineName} Stop\nReason: ${stopReason}\nTime: ${startTime}`;
            const encodedMessage = encodeURIComponent(message);
            const phoneNumber = '60175347817'; 
            const whatsappURL = `https://wa.me/${phoneNumber}?text=${encodedMessage}`;

            window.open(whatsappURL, '_blank');
        }

        function sendWhatsAppStopMessage(machineName, stopReason, startTime, totalElapsed, picName) {
            const message = `${machineName} Stop\nReason: ${stopReason}\nTime: ${startTime}\nElapsed: ${totalElapsed}\nPIC Name: ${picName}`;
            const encodedMessage = encodeURIComponent(message);
            const phoneNumber = '60175347817';
            const whatsappURL = `https://wa.me/${phoneNumber}?text=${encodedMessage}`;

            window.open(whatsappURL, '_blank');
        }

        function enableAllControls(machine) {
            reasons.forEach(reason => {
                const startBtn = document.getElementById(`${machine}-${reason}-start-btn`);
                const stopBtn = document.getElementById(`${machine}-${reason}-stop-btn`);
                const reasonName = document.getElementById(`${machine}-${reason}-reason-name`);
                if (startBtn) {
                    startBtn.classList.remove('disabled');
                    startBtn.disabled = false;
                }
                if (stopBtn) {
                    stopBtn.classList.remove('disabled');
                    stopBtn.disabled = false;
                }
                if (reasonName) {
                    reasonName.classList.remove('disabled');
                }
            });
        }

        function exportData() {
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;

            if (!startDate || !endDate) {
                alert('Please select start and end dates.');
                return;
            }

            const startTime = new Date(startDate).getTime();
            const endTime = new Date(endDate).getTime();

            if (startTime >= endTime) {
                alert('End date must be after start date.');
                return;
            }

            let filteredData = csvData.filter(row => {
                const rowStartTime = new Date(row.startTime).getTime();
                return rowStartTime >= startTime && rowStartTime <= endTime;
            });

            if (filteredData.length === 0) {
                alert('No data found for the selected date range.');
                return;
            }

            const csvContent = 'data:text/csv;charset=utf-8,' +
                filteredData.map(row => Object.values(row).join(',')).join('\n');

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement('a');
            link.setAttribute('href', encodedUri);
            link.setAttribute('download', 'exported_data.csv');
            document.body.appendChild(link);
            link.click();
        }

        function loadState() {
            const dbRef = ref(database, 'machineStopTracker');

            onValue(dbRef, (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    Object.keys(data).forEach(machine => {
                        if (!stopTimes[machine]) return;
                        stopTimes[machine] = data[machine];
                        updateMachineDisplay(machine);

                        reasons.forEach(reason => {
                            if (stopTimes[machine][reason]) {
                                updateDisplay(machine, reason);
                            }
                        });
                    });
                }
            });
        }

        function saveState() {
            const dbRef = ref(database, 'machineStopTracker');
            set(dbRef, stopTimes);
        }

        window.startStop = function(machine, reason) {
            if (machineRunning[machine]) {
                alert('Machine is already running.');
                return;
            }

            const now = Date.now();
            stopTimes[machine][reason].start = now;
            stopTimes[machine][reason].reasonElapsed = 0;
            stopTimes[machine][reason].elapsed = 0;
            stopTimes[machine].machineStart = now;
            stopTimes[machine].totalElapsed = 0;
            machineIntervals[machine] = setInterval(() => updateDisplay(machine, reason), 1000);
            machineRunning[machine] = true;
            disableMachineControls(machine, reason);
            enableStopButton(machine, reason);
            sendWhatsAppStartMessage(machine, reason, formatTimestamp(now));

            saveState(); // Save state to Firebase
        }

        window.stopStop = function(machine, reason) {
            if (!machineRunning[machine]) {
                alert('Machine is not running.');
                return;
            }

            clearInterval(machineIntervals[machine]);
            const now = Date.now();
            stopTimes[machine][reason].elapsed += Math.floor((now - stopTimes[machine][reason].start) / 1000);
            stopTimes[machine][reason].start = null;
            stopTimes[machine].totalElapsed += stopTimes[machine][reason].elapsed;
            stopTimes[machine].machineStart = null;
            machineRunning[machine] = false;
            updateMachineDisplay(machine);
            sendWhatsAppStopMessage(machine, reason, formatTimestamp(stopTimes[machine][reason].start), formatTime(stopTimes[machine][reason].elapsed), prompt('Enter PIC name'));

            saveState(); // Save state to Firebase
        }

        window.resetMachine = function(machine) {
            const isAnyTimerRunning = Object.values(stopTimes[machine]).some(reasonData => reasonData.start !== null);

            if (isAnyTimerRunning) {
                alert('Machine cannot be reset while timers are running.');
                return;
            }

            if (confirm('Are you sure you want to reset the machine timers?')) {
                stopTimes[machine] = {};
                reasons.forEach(reason => {
                    stopTimes[machine][reason] = { start: null, elapsed: 0, reasonElapsed: 0, history: [] };
                });
                stopTimes[machine].totalElapsed = 0;
                stopTimes[machine].machineStart = null;
                saveState(); // Save state to Firebase
                updateMachineDisplay(machine);
            }
        }

        window.onload = init;
    </script>
</head>
<body>
    <div id="machines"></div>
    <input type="date" id="start-date">
    <input type="date" id="end-date">
    <button onclick="exportData()">Export Data</button>
</body>
</html>
